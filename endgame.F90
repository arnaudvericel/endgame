!-------
! endgame program that compute the drift, growth and fragmentation
! of grain(s) in a given disc with one or multiple snow line(s)
!-------

program endgame
 use config,      only: tmax,dt,rin,nsteps,nmax,r,s,St,vrelonvfrag,vd,vdri,vvi,rho,ndumps,dir,&
                        au,years,step,nprev,ntic,iexist,ndust,output,iam,iwas,dsdt
 use evolve,      only: evol,init
 use functions,   only: rho_g,epsi,press

 integer          :: k = 0,count = 0,skip(200) = 0

 write (6,"('>',115('_'),'<')")
 write(6,40)
 40 format(/, &
 6x,'@@@@@@@@@@@% /@@@@     @@@@@ @@@@@@@@&,         @@@@@ @          @@@       @@@@@      @@@@@  @@@@@@@@@@@@',/, &
 6x,'&@@      @%   @@@@%     @,   .@@     .@@@   @@@      @@        &&@@@       @@@@@     @@@@*    @@@      @',/, &
 6x,'&@@   @.      @#/@@@    @,   .@@      ,@@  @@@        @       .@  @@       @@*@@(   *@ @@*    @@@    ',/, &
 6x,'&@@@@@@       @#  @@@   @,   .@@       @@* @@&                @@@@@@@      @@ @@@   @  @@*    @@@@@@@',/, &
 6x,'&@@   @   @   @#   @@@  @,   .@@      ,@@  @@@     @@@@@     @,    @@@     @@  @@@ @@  @@*    @@@  /@  @.',/, &
 6x,'&@@      @@   @#    @@@#@,   .@@      @@@  .@@/      @@#    @@     .@@&    @@   @@&@   @@*    @@@     .@',/, &
 6x,'@@@@@@@@@@@@ /@@@@    ,@@@,  @@@@@@@@@@@      @@@@@@@@*@#  @@@@&   &&@@@@* @@@@  &@@  @@@@@@ &@@@@@@@@@@@',/)
 write (6,"('>',115('_'),'<')")

!- init everything
 call init()

!- open output files and overwrite them if they already exist
 do k=1,ndust
    inquire(file=output(k), exist=iexist(k))
    if (iexist(k)) then
       open(unit=k+100,file=output(k),form="formatted",status="old",action="write")
    else
       open(unit=k+100,file=output(k),form="formatted",status="new",action="write")
    endif
 enddo

 do while (t .le. tmax)
    do k=1,ndust
       if (skip(k) == 1) cycle
       call evol(r(k),s(k),dsdt(k),vd(k),vdri(k),vvi(k),St(k),vrelonvfrag(k),rho(k),iam(k),iwas(k))
       if (r(k) < rin) skip(k) = 1
    enddo
    t = t + dt
    step = step + 1
    steptot = nmax * nsteps
    do k=1,ndust
       if (mod(step,nsteps*nmax/ndumps) == 0) write(k+100,*) t/years,r(k)/au,&
       abs(vd(k)),vdri(k),vvi(k),s(k),dsdt(k)*years*1000,St(k),vrelonvfrag(k),&
       rho(k),rho_g(r(k)),epsi(r(k)),press(r(k))
    enddo
    ntic = int(100 * real(step) / real(steptot))
    do k = nprev + 1, ntic
       if (mod(k,10) == 0) then
          if (k .ne. 100) then
             write(0,'(i2,a)',advance='no') k,'%'
          else
             write(0,'(i3,a,/)',advance='no') k,'%'
#ifdef THANOS
             write(0,*) 'Is it done ?'
             call sleep(1)
             write(0,*) 'Yes.'
             call sleep(1)
             write(0,*) 'What did it cost ?'
             call sleep(2)
             write(0,*) 'Everything.'
             call sleep(1)
#endif
          endif
       else
          write(0,'(a)',advance='no') '-'
       endif
    enddo
    nprev = ntic
 enddo

 do k=1,ndust
    close(k+100)
 enddo

 do k=1,ndust
    call system('mv ' // output(k) // ' ' // adjustl(trim(dir)))
 enddo

 call system('cp dust.in ' // ' ' // adjustl(trim(dir)))
 call system('mv dust.dat ' // ' ' // adjustl(trim(dir)))
 call system('cp disc.in' // ' ' // adjustl(trim(dir)))

#ifdef THANOS
write(6,50)
50 format(/, &
6x,'**************/**,,,,,,,,,,,,,**//////*,,,,,,**,**,,,,,,,,,,,,*,,,,,,,,,,,,,,,,,,,,,,,,,,',/, &
6x,'************(*,,,,,,,,,,,,,,,,,,,,,,*,,.,*,**,,,*,,,,,,,,,,*,,,*,,,,,,,,,,,,,,,,,,,,,,,,,',/, &
6x,'**********//,,,,,,,,,,,,,.,,,,,,,,,..,....*,,,,*,,,,,,,,,,,,,,,,**,,,,,,,,,,,,,,,,,,,,,,,',/, &
6x,'*********#***,**,,,,,,,,,,,.,.,,,***,,***,*,,,.,,,,,,,,,,,,,,,,****,,,,,,,,,,,,,,,,,,,,,,',/, &
6x,'********/********,,,,,,.....,,,,,,,,,,,,.,,,,,*,,,,*,.,..,,,,,,****/,,,,,,,,,,,,,,,,,,,,,',/, &
6x,'*******/**/******,,,,..,,,,,,,,,,,,,,*****,,.,,,,,**..,,.,,,.,*,,***/,,,,,,,,,,,,,,,,,,,,',/, &
6x,'******/**/******,,,,,,,,,,,,,,,,,,,,,,.,,*,,,,,,,,**.,,.,.,,,,*,,,****,,,,,,,,,,,,,,,,,,,',/, &
6x,'*****#**********,,,,,,,,,,,,,.......,,,,,,,.,,,,,,,*...,...,,,,,,,,****,,,,,,,,,,,,,,,,,,',/, &
6x,'*****#***********,,,,,*,,,.....................,,,,,,,.......,,,,,,,**/*,,,,,,,,,,,,,,,,,',/, &
6x,'****/#********,,,,,,,**,,..,.......,...............,,,,,.....,,,,,,,,*/**,,,,,,,,,,,,,,,,',/, &
6x,'****##*****,***,,,,,,,*,,..,...,,,,.....,............,,,,.,**,,,,,,,,/(**,***,,,,,,,,,,,,',/, &
6x,'****#((********,,,.,,,,,,,,,,,,........,.,,,...........,*/*,,,,,,,,,,,.,..,...*,,,,,,,,,,',/, &
6x,'****##**********,,,,*,,............,................,,***,,,,,,,,,,,,,,,,.......,,,,,,,,,',/, &
6x,'****(%****/***,**,,,**,.................,...........,*,,...,,,,,,,,,**,..,..,,*.,,,,,,,,,',/, &
6x,'*****%//****,,,,,,,,**,,................,...........,.......,,,,,*****,*,.,....,,*,,,,,,,',/, &
6x,'*****##**,,,,.......,*,,.....................................,,,,**,,*,,,.,,....,,,,,,,,,',/, &
6x,'*****%**,,,,,,.......,,.........................,...........,,,**,,,,,***.......,.*,,,,,,',/, &
6x,'*****(*****,,,.......,,..........................,,........,,****,,,,,***,,,,*,,*,,,,,,,,',/, &
6x,'******(*,**,,.......,**,,,.................................,,,*,,,,,,,****,,,,**.*,,,,,,,',/, &
6x,'*******(**,,**,....*/*,,,,,.............................,,,,,,,,,,,,,,,****.,,*,,/,,,,,,,',/, &
6x,'*******#**,****,,****,,,,,......,.......................,,,,,,,,,,,,,,,,,**...,*/*,,,,,,,',/, &
6x,'*******(%*******/***...,,,.,............................,*,,,.,,,,,,,,,,,,*,...,*/,,,,,,,',/, &
6x,'*******(*******,/*,.*..,*,.............................,,,,,,.,,,,,,,,,,,,,*,.,***/,,,,,,',/, &
6x,'******(#********,,..***,,..,,..........................,,,,,,,,,,,.,,,,,,,**/..,***/,,,,*',/, &
6x,'******/#********,..,**,*,...,*...........................,,,,,,,,,,,,,,,,****,..****/*,*,',/, &
6x,'/******#*,******..,,****,...,*,............................,..,,,,,,,,,,,,****..,***/(*,,',/, &
6x,'********(*****,,..,,,***,..,*..............................,,,..,,,,,,,,,,,***,..,****(,,',/, &
6x,'****//*//((***,,..,,***,,,,.................................,,*...,,,,,,,,,,***..,,,**/(,',/, &
6x,'///*/*///*//,*,,.,,,,*,,,,,..................................,,*,,.,,,..,,,,,,,,...**/*/(',/, &
6x,'///////////(***,.,*,*,.,...,,*,,...,..........................,*,,,,,.,,,,,,,,,,....,,,,(',/, &
6x,'///////////*(*,,.*,**,.,***,,.,,...............................,*.,*,,,,,,,,,.,..........',/, &
6x,'///////////**(*,.*,,,,*/**.,...................................,*,,,,,*,*,,,.............',/, &
6x,'//////////***(*,,*,,.**,.,.,,...................................,*,,,,***,...............',/, &
6x,'/////////****//,.*,.**,,....,...................................,*,,,*,,.................',/, &
6x,'/////////*****/*,,,,,,,.,...,,..,.,,............................,,.,,....................',/, &
6x,'///////////***(*,,,,,,,,.,,,,,,..,,,..............................,......................',/, &
6x,'///////////***/(,,*,,,,,,,,,,,,..,,,,....................................................',/, &
6x,'/////////////*/(*,,,,,,,*,,,.,,,..,,.....................................................',/, &
6x,'/////////////////,,,,,,,,,,,.,,...,,.....................................................',/, &
6x,'//////////////***/,,,,,,,,,........,.....................................................',/, &
6x,'//////////////*****,,,,,,,,,...,.....,...................................................',/, &
6x,'//////////////***..*,,,.,,.,....,....,,..................................................',/, &
6x,'///////////////*...(,,,.,,.,,...,,....,..................................................',/, &
6x,'////////////////,...,.,.,,..,....,,......................................................',/, &
6x,'////////////////*...*,,,.,,.,,....,......................................................',/, &
6x,'/////////////////,...,,,,.,,.............................................................',/, &
6x,'/////////////////*.....,,,...............................................................',/, &
6x,'/////////////////*.........,,.......................................... .................',/, &
6x,'//////////////////..........,,,,,,.,.....................................................',/)
#endif

 do k = 1,ndust
    if (r(k) > rin) count = count + 1
 enddo
 if (count >= 1) then
#ifdef THANOS
    write(6,*) ''
    write(6,'(a,i2,a,i2,a)') '"Reality can be whatever I want:',count,' out of ',ndust,' grain(s) are still in the disc."'
    write(6,*) ''
 if (count == ndust/2) write(6,'(a)') 'YOUUUU.... should have gone for the HEAD ! **SNAP**'
#else
    write(6,'(i3,a,i3,a,f6.1,a)') count,' out of ',ndust,' grain(s) are still in the disc after ',tmax/years/1000, ' kyrs.'
#endif
 else
#ifdef THANOS
    write(6,*) 'Reality is often disapointing: all the grains have been accreted.'
#else
    write(6,*) 'All the grains have been accreted.'
#endif
 endif
 close(2)

end program endgame
